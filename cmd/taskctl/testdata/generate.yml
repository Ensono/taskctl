# yaml-language-server: $schema=../../../schemas/schema_v1.json

output: prefixed
# import:
#   - https://raw.githubusercontent.com/Ensono/stacks-infrastructure-eks/11fcb55621bee0f24ebf2fdbacc7ced7be6ec5d8/build/taskctl/tasks.yaml

generator:
  version: v1.8.0-alpha-aaaabbbb1234
  targetOpts:
    github:
      "on":
        push:
          branches:
            - main
            - master
        pull_request:
          branches:
            - main
            - master
      env:
        TASKCTL_CONFIG_FILE: cmd/taskctl/testdata/generate.yml

contexts:
  podman:
    container:
      name: alpine:latest
    env: 
      GLOBAL_VAR: this is it
      TF_VAR_name_company: ${{ env.COMPANY }}
      TF_VAR_name_project: ${{ env.PROJECT }}
      TF_VAR_name_component: ${{ env.COMPONENT }}
      TF_VAR_region: ${{ env.REGION }}
    envfile:
      exclude:
        - HOME

pipelines:
  prod:
    - pipeline: graph:pipeline2
      # depends_on: [graph:task3]
  graph:pipeline1:
    - task: graph:task2
      depends_on: 
        - graph:task1
    - task: graph:task3
      depends_on: [graph:task1]
    - name: dev
      pipeline: graph:pipeline2
      depends_on: [graph:task3]
    # - name: prod
    #   graph:pipeline2
    - pipeline: prod
      depends_on: [graph:task3]
    - task: graph:task4
      depends_on:
        - graph:task2
    - task: graph:task1
      # depends_on:
      #   - graph:task2
    - pipeline: graph:pipeline3
      depends_on:
        - graph:task4

  graph:pipeline2:
    - task: task-p2:2
    - task: task-p2:1
      depends_on:
        - task-p2:2

  graph:pipeline3:
    - task: graph:task2
      # depends_on:
      #   - graph:task3
    - task: graph:task3
      # depends_on:
      #   - graph:task2

tasks:
  graph:task1:
    command: |
      for i in $(seq 1 5); do
        echo "hello task 1 - iteration $i"
        sleep 0
      done
    context: podman

  graph:task2:
    command: |
      echo "hello task 2"
    context: podman

  graph:task3:
    command: "echo 'hello, task3!'"
    env:
      FOO: bar

  graph:task4:
    command: | 
      echo "hello, task4"
    context: podman
    env:
      FOO: bar

  task-p2:1:
    command:
      - |
        echo "hello, p2 ${FOO}"
    context: podman
    env:
      FOO: task1

  task-p2:2:
    command:
      - |
        for i in $(seq 1 5); do
          echo "hello, p2 ${FOO} - iteration $i"
          sleep 0
        done
    env:
      FOO: task2
